version: "3.9"

services:
  mongo:
    image: mongo:7
    container_name: mae-mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    command: ["--replSet", "rs0"]
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.runCommand({ ping: 1 })"]
      interval: 5s
      retries: 10
      timeout: 5s
    restart: unless-stopped

  mongo-init:
    image: mongo:7
    depends_on:
      mongo:
        condition: service_healthy
    entrypoint: >
      bash -c "
      echo '‚è≥ Attente de MongoDB...' &&
      sleep 10 &&
      echo 'üöÄ Initialisation du Replica Set...' &&
      mongosh mongodb://mongo:27017 --eval '
        try {
          rs.initiate({
            _id: \"rs0\",
            members: [{ _id: 0, host: \"mongo:27017\" }]
          });
        } catch (e) {
          print(\"‚ö†Ô∏è Replica Set d√©j√† initialis√© ou erreur : \" + e);
        }
      ' &&
      echo '‚úÖ Replica Set pr√™t.'"
    restart: "no"

  supervisor:
    build: .
    container_name: mae-supervisor
    env_file: .env
    depends_on:
      mongo-init:
        condition: service_completed_successfully
    restart: unless-stopped

volumes:
  mongo_data: